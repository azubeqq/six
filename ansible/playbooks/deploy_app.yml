---
# ========================================
# MAIN PLAYBOOK
# ========================================
- name: Deploy Flask + PostgreSQL + Monitoring + Logging + Backup
  hosts: aws
  become: true

  roles:
    - docker      # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker
    - app         # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    - loki        # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Loki + Promtail
    - backup      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð²

  post_tasks:
    - name: Wait for services to start
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for all services to initialize..."

    - name: Check running containers
      ansible.builtin.command: >
         {% raw %}docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'{% endraw %}
      register: docker_ps

    - name: Show container status
      ansible.builtin.debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: Show service URLs
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "âœ… Deployment completed successfully!"
          - "========================================="
          - "Flask App:      http://{{ inventory_hostname }}:{{ flask_port }}"
          - "Prometheus:     http://{{ inventory_hostname }}:{{ prometheus_port }}"
          - "Grafana:        http://{{ inventory_hostname }}:{{ grafana_port }} (admin/admin)"
          - "Alertmanager:   http://{{ inventory_hostname }}:{{ alertmanager_port }}"
          - "Loki:           http://{{ inventory_hostname }}:{{ loki_port }}"
          - "========================================="
          - "ðŸ“Š Grafana Dashboards to import:"
          - "  - 11098 (Prometheus Alertmanager)"
          - "  - 13639 (Loki Dashboard)"
          - "  - 1860  (Node Exporter Full)"
          - "========================================="