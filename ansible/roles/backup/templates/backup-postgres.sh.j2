#!/bin/bash
# ========================================
# PostgreSQL Backup Script
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
# ========================================

set -e  # Exit on error

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
BACKUP_DIR="/home/{{ app_user }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/db_backup_${DATE}.sql.gz"
CONTAINER_NAME="postgres_db"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
RETENTION_DAYS={{ backup_retention_days }}

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# –ù–∞—á–∞–ª–æ
log "========================================="
log "Starting PostgreSQL backup"
log "========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
if ! docker ps | grep -q "${CONTAINER_NAME}"; then
    log "‚ùå ERROR: PostgreSQL container '${CONTAINER_NAME}' is not running!"
    exit 1
fi

log "‚úÖ PostgreSQL container is running"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "${BACKUP_DIR}"

# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
log "Creating backup to ${BACKUP_FILE}..."
if docker exec ${CONTAINER_NAME} pg_dump -U ${DB_USER} ${DB_NAME} | gzip > ${BACKUP_FILE}; then
    log "‚úÖ Backup created successfully!"
else
    log "‚ùå ERROR: Failed to create backup!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
if [ -f "${BACKUP_FILE}" ]; then
    BACKUP_SIZE=$(du -h ${BACKUP_FILE} | cut -f1)
    log "üì¶ Backup size: ${BACKUP_SIZE}"
else
    log "‚ùå ERROR: Backup file was not created!"
    exit 1
fi

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
log "Cleaning up old backups (older than ${RETENTION_DAYS} days)..."
DELETED_COUNT=$(find ${BACKUP_DIR} -name "db_backup_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -print -delete | wc -l)
if [ ${DELETED_COUNT} -gt 0 ]; then
    log "üóëÔ∏è  Deleted ${DELETED_COUNT} old backup(s)"
else
    log "‚ÑπÔ∏è  No old backups to delete"
fi

# –ü–æ–¥—Å—á—ë—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –±—ç–∫–∞–ø–æ–≤
BACKUP_COUNT=$(find ${BACKUP_DIR} -name "db_backup_*.sql.gz" -type f | wc -l)
log "üìä Total backups: ${BACKUP_COUNT}"

{% if backup_to_s3 | default(false) %}
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ S3 (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
log "Uploading backup to S3..."
if aws s3 cp ${BACKUP_FILE} s3://{{ s3_backup_bucket }}/postgres-backups/ --region {{ region | default('eu-central-1') }}; then
    log "‚úÖ Backup uploaded to S3 successfully!"
else
    log "‚ö†Ô∏è  WARNING: Failed to upload backup to S3"
fi
{% endif %}

log "========================================="
log "‚úÖ Backup completed successfully!"
log "========================================="
exit 0