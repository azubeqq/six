---
# ========================================
# LOKI ROLE - Logging Stack
# ========================================

- name: Create loki directory
  ansible.builtin.file:
    path: "{{ app_dir }}/loki"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'
  when: enable_loki | default(true)

- name: Template loki config
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ app_dir }}/loki/loki-config.yml"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'
  when: enable_loki | default(true)

- name: Create promtail directory
  ansible.builtin.file:
    path: "{{ app_dir }}/promtail"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'
  when: enable_loki | default(true)

- name: Template promtail config
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ app_dir }}/promtail/promtail-config.yml"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'
  when: enable_loki | default(true)

- name: Show Loki info
  ansible.builtin.debug:
    msg:
      - "âœ… Loki logging stack configured"
      - "Loki will store logs for {{ loki_retention_days }} days"
      - "Access Loki via Grafana Explore"
  when: enable_loki | default(true)